<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link id="favicon" rel="icon" type="image/png" href="favicon.ico">
    <title>Free online image mosaic processing tool</title>
    <meta name="keywords" content="Free online image mosaic processing tool,mosaic down syndrome,fluid mosaic model,mosaic district,mosaic tile,mosaic art,mosaic definition,mosaic tiles,mosaic embryo,mosaic church" />
    <meta name="description" content="Free online image mosaic processing tool,mosaic down syndrome,fluid mosaic model,mosaic district,mosaic tile,mosaic art,mosaic definition,mosaic tiles,mosaic embryo,mosaic church" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V0YFLKRH7D"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-V0YFLKRH7D');
    </script>
    <link rel="stylesheet" href="css.css">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7274710287377352"
     crossorigin="anonymous"></script>
</head>
<body>
    <header class="header-div">
        <h1 class="header-title">Image Mosaic</h1>
        <div class="header-link">
            <a href="https://www.openai2025.com" class="text-white link-a" target="_blank">Chuandao software toolbox</a>
        </div>
    </header>

    <main class="main-div">
        <section class="frame-div upload-section">
            <div class="frame-top">
                <label for="fileBtn" class="file-label">Select Image</label>
                <input type="file" id="fileBtn" accept="image/jpeg,image/gif,image/png,image/bmp,image/webp" />
            </div>
            <div class="frame-center">
                <img id="img" alt="Original image" style="display:none"/>
                <div class="placeholder-text">Please select an image</div>
            </div>
        </section>
        <section class="frame-div result-section">
            <div class="frame-top">
                <div class="controls-group">
                    <label for="rangeInput" class="range-label">Mosaic Intensity: <span id="rangeValue">5</span></label>
                    <input type="range" id="rangeInput" min="1" max="10" value="5" />
                </div>
                <button type="button" id="downloadBtn" class="download-btn">Download Image</button>
            </div>
            <div class="frame-center">
                <img id="convertImg" alt="Mosaic processed image" style="display:none"/>
                <div class="placeholder-text">Processed image will appear here</div>
            </div>
        </section>
    </main>
    <center>(<a href="./index.html">Simplified Chinese</a> | <a href="./index-en.html">English</a>)</center>
    <script type="text/javascript">

        var pix = 5;

        document.getElementById("fileBtn").addEventListener("change",function (e){
            if (window.FileReader) {
                var file = e.target.files[0];
                let reader = new FileReader();
                reader.onload = function (event) {
                    var dataURL = event.target.result;
                    var img = document.getElementById("img");
                    var convertImg = document.getElementById("convertImg");
                    var uploadPlaceholder = img.parentElement.querySelector('.placeholder-text');
                    var resultPlaceholder = convertImg.parentElement.querySelector('.placeholder-text');
                    
                    img.src = dataURL;
                    img.style.display = "block";
                    convertImg.style.display = "block";
                    uploadPlaceholder.style.display = "none";
                    resultPlaceholder.style.display = "none";
                    
                    // 确保两个图片的显示尺寸一致
                    img.onload = function() {
                        convertImg.style.width = img.offsetWidth + 'px';
                        convertImg.style.height = img.offsetHeight + 'px';
                    };
                };
                reader.readAsDataURL(file);
            } else {
                alert("Your browser does not support changing features");
            }
        });

        document.getElementById("img").addEventListener("load",function (e){
            if (e.target.src) {
                showConvertPic();
            }
        });


        document.getElementById("rangeInput").addEventListener("change", function (e) {
            if (document.getElementById("img").src) {
                pix = parseInt(e.target.value);
                document.getElementById("rangeValue").textContent = pix;
                showConvertPic();
            }
        });

        document.getElementById("downloadBtn").addEventListener("click",function (e){
            var convertImg = document.getElementById("convertImg");
            if(!!convertImg.src){
                download(convertImg.src);
            } else {
                alert("Please upload the image first");
            }
        });

        function showConvertPic(){
            var img = document.getElementById("img");
            var convertImg = document.getElementById("convertImg");
            convertImg.src = createRevertPic(img);
            
            // 确保右边图片的显示尺寸与左边图片一致
            convertImg.style.width = img.style.width || img.offsetWidth + 'px';
            convertImg.style.height = img.style.height || img.offsetHeight + 'px';
        }

        function createRevertPic(img){
            var canvas = document.createElement("canvas");
            // 使用图片的原始尺寸，而不是显示尺寸
            canvas.width = img.naturalWidth;   
            canvas.height = img.naturalHeight;
            var ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight);  
            var c = ctx.getImageData(0, 0, img.naturalWidth, img.naturalHeight);
            var height = c.height;
            var width = c.width;
            for(var i = 0; i < height; i+=pix){
                for(var j = 0; j < width; j+=pix){
                    var rAvg = 0;
                    var gAvg = 0;
                    var bAvg = 0;
                    var aAvg = 0;
                    var count = 0;
                    outerFor:for (var iPix = i; iPix < i+pix; iPix++) {
                        for (var jPix = j; jPix < j+pix; jPix++) {
                            if (iPix > height) {
                                break;
                            } else if(jPix>width){
                                break outerFor;
                            }
                            var x = iPix*4*width + 4*jPix;
                            count++;
                            rAvg += c.data[x];
                            gAvg += c.data[x+1];
                            bAvg += c.data[x+2];
                            aAvg += c.data[x+3];
                        }
                        
                    }
                    rAvg /= (count);
                    gAvg /= (count);
                    bAvg /= (count);
                    aAvg /= (count);

                    outerFor:for (var iPix = i; iPix < i+pix; iPix++) {
                        for (var jPix = j; jPix < j+pix; jPix++) {
                            if (iPix > height) {
                                break;
                            } else if(jPix>width){
                                break outerFor;
                            }
                            var x = iPix*4*width + 4*jPix;
                            c.data[x] = rAvg
                            c.data[x+1] = gAvg;
                            c.data[x+2] = bAvg; 
                            c.data[x+3] = aAvg;
                        }
                    }
                }
            }
            ctx.putImageData(c,0,0);
            return canvas.toDataURL();
        }


        function download(src) {
            var $a = document.createElement('a');
            $a.setAttribute("href", src);
            $a.setAttribute("download", "");

            var evObj = document.createEvent('MouseEvents');
            evObj.initMouseEvent('click', true, true, window, 0, 0, 0, 0, 0, false, false, true, false, 0, null);
            $a.dispatchEvent(evObj);
        };
        
    </script>  

</body>
</html>
